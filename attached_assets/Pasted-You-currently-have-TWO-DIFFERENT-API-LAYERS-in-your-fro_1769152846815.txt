You currently have TWO DIFFERENT API LAYERS in your frontend, both exporting API_BASE_URL and apiRequest, and they do not behave identically.
Thatâ€™s why:
login works
some calls work
some calls hit Vite HTML
some calls lose session â†’ 401
some URLs turn into /api/clinics/[object Object]
Letâ€™s break it down cleanly and fix it once.
ğŸš¨ Problem #1: Duplicate API implementations (critical)
You have both of these in your project:
ğŸ”´ File A (simpler one)
export const API_BASE_URL = import.meta.env.VITE_API_URL || "";

export async function apiRequest(...) {
  const url = `${API_BASE_URL}${endpoint}`;
  fetch(url, { credentials: "include" });
}
ğŸ”´ File B (React Query version)
const API_BASE_URL =
  import.meta.env.VITE_API_URL ||
  (import.meta.env.MODE === "development"
    ? "http://localhost:5000"
    : "https://book-my-slot-1.onrender.com");
â¡ï¸ Different defaults
â¡ï¸ Different URL joining logic
â¡ï¸ Different error handling
â¡ï¸ Different fetch usage
âš ï¸ Depending on which file is imported, requests go to:
backend âœ…
OR Vite dev server âŒ (HTML response)
OR wrong URL ([object Object])
ğŸš¨ Problem #2: [object Object] in URL (this is frontend)
This curl is the smoking gun:
/api/clinics/[object%20Object]
That means somewhere you are doing:
apiRequest("GET", clinic)   // âŒ clinic is an object
Instead of:
apiRequest("GET", `/api/clinics/${clinic.id}`) // âœ…
React Query invalidation then re-fires this broken request.
Thatâ€™s why after success, it suddenly explodes.
ğŸš¨ Problem #3: Vite HTML response = wrong server
When you see this:
<script type="module" src="/@vite/client"></script>
It means:
âŒ Request went to Vite (5173)
âŒ NOT to Express (5001 / Render)
This happens when:
API_BASE_URL === ""
OR wrong import
OR mixed helpers
âœ… THE FIX (do this exactly)
âœ… Step 1: DELETE ONE API FILE
You must have ONE source of truth.
ğŸ‘‰ KEEP the React Query version
ğŸ‘‰ DELETE the simpler apiRequest file
No debate here â€” two API layers = chaos.
âœ… Step 2: Single canonical API base
// api.ts (ONLY FILE)
export const API_BASE_URL = import.meta.env.VITE_API_URL!;

if (!API_BASE_URL) {
  throw new Error("VITE_API_URL is not defined");
}
ğŸ’¡ No fallbacks. No guessing. Env must be correct.
âœ… Step 3: One apiRequest (final version)
export async function apiRequest(
  method: string,
  url: string,
  data?: unknown
): Promise<Response> {
  const fullUrl = url.startsWith("http")
    ? url
    : `${API_BASE_URL}${url}`;

  return fetch(fullUrl, {
    method,
    credentials: "include",
    headers: data ? { "Content-Type": "application/json" } : {},
    body: data ? JSON.stringify(data) : undefined,
  });
}
âœ… Step 4: Fix React Query invalidation
You currently have:
queryClient.invalidateQueries({ queryKey: ['/api/clinics'] });
âœ… Thatâ€™s correct
âŒ But somewhere the query function is doing:
const url = queryKey.join("/");
If queryKey ever contains an object â†’ ğŸ’¥
ğŸ”§ Safer version
const url = queryKey[0] as string;
Change this:
const url = queryKey.join("/") as string;
To:
const url = queryKey[0] as string;
âœ… Step 5: Verify session works (final test)
After login:
GET /api/auth/clinic/bookings
You must see:
{
  adminLoggedIn: true,
  clinicId: 3
}
If you see only cookie â†’ request did NOT send session â†’ wrong API helper still used.
ğŸ§  Why prod WILL fail if you donâ€™t fix this
Render = HTTPS + proxy + strict cookies
Any request that:
hits Vite
misses credentials
hits wrong base URL
â¡ï¸ silent session loss
â¡ï¸ random 401
â¡ï¸ HTML instead of JSON
âœ… Final verdict (straight talk)
You donâ€™t have a backend bug.
You donâ€™t have a cookie bug.
You have frontend API duplication.
Fix that, and:
401s disappear
[object Object] disappears
Vite HTML disappears
prod works first try ğŸš€
If you want, paste:
your clinic list query
your invalidateQueries call
Iâ€™ll pinpoint the exact [object Object] line in seconds.