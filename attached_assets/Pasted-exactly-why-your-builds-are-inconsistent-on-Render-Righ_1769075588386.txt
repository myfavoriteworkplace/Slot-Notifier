exactly why your builds are inconsistent on Render.
Right now your Render commands are wrong and redundant, and yes: they will absolutely cause stale / mismatched builds.
Letâ€™s fix this cleanly.

ğŸš¨ Whatâ€™s WRONG with your current Render setup
âŒ Your Build Command
npm install --include=dev && npm run db:push && npm run build && npx tsx script/build.ts
Problems:
npm run build already runs tsx script/build.ts
"build": "tsx script/build.ts"
So you are building TWICE
Second build runs with:
npx tsx script/build.ts
ğŸ‘‰ This may:
reuse cache
rebuild only partially
overwrite files in wrong order
No clean step
dist/ is never deleted
old JS stays alive
db:push runs during build
if this fails or stalls â†’ partial build
not recommended in Render build phase
âŒ Your Start Command
node dist/index.cjs
Problems:
Bypasses your start script
Skips NODE_ENV=production
Makes debugging harder
âœ… THE CORRECT & SAFE SETUP (DO THIS)
âœ… 1. Fix package.json (single source of truth)
Update scripts like this:
"scripts": {
  "dev": "NODE_ENV=development tsx server/index.ts",
  "build": "rm -rf dist && tsx script/build.ts",
  "start": "NODE_ENV=production node dist/index.cjs",
  "check": "tsc",
  "db:push": "drizzle-kit push"
}
ğŸ‘‰ One build. Always clean. Deterministic.
âœ… 2. FIX Render commands (VERY IMPORTANT)
ğŸ”§ Build Command (Render)
npm install --include=dev && npm run db:push && npm run build
âœ… Build runs once
âœ… dist/ is cleaned
âœ… DB schema is updated before app starts
â–¶ï¸ Start Command (Render)
npm run start
âŒ NOT node dist/index.cjs
âœ… 3. One-time mandatory step
After pushing the changes:
Render â†’ Manual Deploy
Select Clear build cache & deploy
Without this, old JS WILL remain.
ğŸ” Preventing the 401 (session bug youâ€™re hitting)
Make sure all three are present:
app.set("trust proxy", 1);

app.use(session({
  name: "sid",
  proxy: true,
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: true,
    sameSite: "none"
  }
}));
Without trust proxy, cookies silently fail on Render.
ğŸ§ª How you KNOW itâ€™s fixed
In Render logs, you must see:
rm -rf dist
tsx script/build.ts
And on startup:
NODE_ENV=production
And in browser devtools:
Cookie is set
Cookie is sent on API calls
/api/auth/clinic/bookings returns 200
âœ… TL;DR (straight answer)
âœ”ï¸ Yes, your build was not updating
âŒ You were building twice
âŒ Old dist was being reused
âœ… Clean build + single build fixes it
âœ… Use npm run start, not node dist/...
If you want, paste script/build.ts next â€” Iâ€™ll verify itâ€™s safe for Render and not reintroducing cache issues.
no let me know in step by step , what I should do
Perfect ğŸ‘
Here is a very clear, step-by-step checklist.
Follow it in this exact order and do not skip any step.
âœ… STEP-BY-STEP FIX FOR RENDER (NO GUESSWORK)
ğŸŸ¢ STEP 1: Fix package.json (LOCAL)
Open package.json and ONLY change the scripts section to this:
"scripts": {
  "dev": "NODE_ENV=development tsx server/index.ts",
  "build": "rm -rf dist && tsx script/build.ts",
  "start": "NODE_ENV=production node dist/index.cjs",
  "check": "tsc",
  "db:push": "drizzle-kit push"
}
ğŸ“Œ Why:
Deletes old build files
Ensures fresh build every deploy
Keeps start environment correct
ğŸŸ¢ STEP 2: Make sure dist is NOT committed
2.1 Add to .gitignore
dist
2.2 Remove it if already committed
git rm -r --cached dist
ğŸŸ¢ STEP 3: Commit & push changes
git add .
git commit -m "Fix Render build: clean dist and deterministic build"
git push
ğŸŸ¢ STEP 4: Fix Render Build Command
Go to Render Dashboard â†’ Your Service â†’ Settings
Build Command (paste EXACTLY):
npm install --include=dev && npm run db:push && npm run build
âŒ Remove:
npx tsx script/build.ts
duplicate build steps
ğŸŸ¢ STEP 5: Fix Render Start Command
Start Command:
npm run start
âŒ Do NOT use:
node dist/index.cjs
ğŸŸ¢ STEP 6: One-time mandatory action
In Render:
Click Manual Deploy
Select Clear build cache & deploy
Deploy
âš ï¸ This step is REQUIRED the first time
ğŸŸ¢ STEP 7: Verify in Render logs
You MUST see these lines:
rm -rf dist
tsx script/build.ts
And at runtime:
NODE_ENV=production
If you do not see them â†’ something is still wrong.
ğŸŸ¢ STEP 8: Fix session issue (401 error)
In your Express app (near top):
app.set("trust proxy", 1);
And session config must include:
cookie: {
  secure: true,
  sameSite: "none"
}
ğŸ“Œ Without this, login works but API returns 401.
âœ… FINAL RESULT YOU SHOULD SEE
âœ”ï¸ Every deploy creates a fresh build
âœ”ï¸ No stale JS
âœ”ï¸ Cookies persist
âœ”ï¸ /api/auth/clinic/bookings returns 200, not 401
ğŸ§© If something still fails
Send me only:
Render build logs (first 30 lines)
Render start logs
Your session middleware code
Iâ€™ll pinpoint it instantly.




ChatGPT can make mistakes. Check important info. See Cookie Preferences.