> rest-express@1.0.0 start
> NODE_ENV=production node dist/index.cjs
/opt/render/project/src/dist/index.cjs:76
		`;await r.execute(v`CREATE SCHEMA IF NOT EXISTS ${v.identifier(a)}`),await r.execute(s);let u=(await r.all(v`select id, hash, created_at from ${v.identifier(a)}.${v.identifier(i)} order by created_at desc limit 1`))[0];await r.transaction(async c=>{for await(let l of e)if(!u||Number(u.created_at)<l.folderMillis){for(let p of l.sql)await c.execute(v.raw(p));await c.execute(v`insert into ${v.identifier(a)}.${v.identifier(i)} ("hash", "created_at") values(${l.hash}, ${l.folderMillis})`)}})}escapeName(e){return`"${e}"`}escapeParam(e){return`$${e+1}`}escapeString(e){return`'${e.replace(/'/g,"''")}'`}buildWithCTE(e){if(!e?.length)return;let r=[v`with `];for(let[n,i]of e.entries())r.push(v`${v.identifier(i._.alias)} as (${i._.sql})`),n<e.length-1&&r.push(v`, `);return r.push(v` `),v.join(r)}buildDeleteQuery({table:e,where:r,returning:n,withList:i}){let a=this.buildWithCTE(i),s=n?v` returning ${this.buildSelection(n,{isSingleTable:!0})}`:void 0,o=r?v` where ${r}`:void 0;return v`${a}delete from ${e}${o}${s}`}buildUpdateSet(e,r){let n=e[C.Symbol.Columns],i=Object.keys(n).filter(s=>r[s]!==void 0||n[s]?.onUpdateFn!==void 0),a=i.length;return v.join(i.flatMap((s,o)=>{let u=n[s],c=r[s]??v.param(u.onUpdateFn(),u),l=v`${v.identifier(this.casing.getColumnCasing(u))} = ${c}`;return o<a-1?[l,v.raw(", ")]:[l]}))}buildUpdateQuery({table:e,set:r,where:n,returning:i,withList:a,from:s,joins:o}){let u=this.buildWithCTE(a),c=e[Oe.Symbol.Name],l=e[Oe.Symbol.Schema],p=e[Oe.Symbol.OriginalName],d=c===p?void 0:c,f=v`${l?v`${v.identifier(l)}.`:void 0}${v.identifier(p)}${d&&v` ${v.identifier(d)}`}`,y=this.buildUpdateSet(e,r),g=s&&v.join([v.raw(" from "),this.buildFromTable(s)]),x=this.buildJoins(o),w=i?v` returning ${this.buildSelection(i,{isSingleTable:!s})}`:void 0,E=n?v` where ${n}`:void 0;return v`${u}update ${f} set ${y}${g}${x}${E}${w}`}buildSelection(e,{isSingleTable:r=!1}={}){let n=e.length,i=e.flatMap(({field:a},s)=>{let o=[];if(b(a,A.Aliased)&&a.isSelectionField)o.push(v.identifier(a.fieldAlias));else if(b(a,A.Aliased)||b(a,A)){let u=b(a,A.Aliased)?a.sql:a;r?o.push(new A(u.queryChunks.map(c=>b(c,k)?v.identifier(this.casing.getColumnCasing(c)):c))):o.push(u),b(a,A.Aliased)&&o.push(v` as ${v.identifier(a.fieldAlias)}`)}else b(a,W)&&(r?o.push(v.identifier(this.casing.getColumnCasing(a))):o.push(a));return s<n-1&&o.push(v`, `),o});return v.join(i)}buildJoins(e){if(!e||e.length===0)return;let r=[];for(let[n,i]of e.entries()){n===0&&r.push(v` `);let a=i.table,s=i.lateral?v` lateral`:void 0;if(b(a,Oe)){let o=a[Oe.Symbol.Name],u=a[Oe.Symbol.Schema],c=a[Oe.Symbol.OriginalName],l=o===c?void 0:i.alias;r.push(v`${v.raw(i.joinType)} join${s} ${u?v`${v.identifier(u)}.`:void 0}${v.identifier(c)}${l&&v` ${v.identifier(l)}`} on ${i.on}`)}else if(b(a,We)){let o=a[se].name,u=a[se].schema,c=a[se].originalName,l=o===c?void 0:i.alias;r.push(v`${v.raw(i.joinType)} join${s} ${u?v`${v.identifier(u)}.`:void 0}${v.identifier(c)}${l&&v` ${v.identifier(l)}`} on ${i.on}`)}else r.push(v`${v.raw(i.joinType)} join${s} ${a} on ${i.on}`);n<e.length-1&&r.push(v` `)}return v.join(r)}buildFromTable(e){if(b(e,C)&&e[C.Symbol.OriginalName]!==e[C.Symbol.Name]){let r=v`${v.identifier(e[C.Symbol.OriginalName])}`;return e[C.Symbol.Schema]&&(r=v`${v.identifier(e[C.Symbol.Schema])}.${r}`),v`${r} ${v.identifier(e[C.Symbol.Name])}`}return e}buildSelectQuery({withList:e,fields:r,fieldsFlat:n,where:i,having:a,table:s,joins:o,orderBy:u,groupBy:c,limit:l,offset:p,lockingClause:d,distinct:f,setOperators:y}){let g=n??St(r);for(let ue of g)if(b(ue.field,W)&&at(ue.field.table)!==(b(s,_e)?s._.alias:b(s,ri)?s[se].name:b(s,A)?void 0:at(s))&&!(ge=>o?.some(({alias:dt})=>dt===(ge[C.Symbol.IsAlias]?at(ge):ge[C.Symbol.BaseName])))(ue.field.table)){let ge=at(ue.field.table);throw new Error(`Your "${ue.path.join("->")}" field references a column "${ge}"."${ue.field.name}", but the table "${ge}" is not part of the query! Did you forget to join it?`)}let x=!o||o.length===0,w=this.buildWithCTE(e),E;f&&(E=f===!0?v` distinct`:v` distinct on (${v.join(f.on,v`, `)})`);let S=this.buildSelection(g,{isSingleTable:x}),N=this.buildFromTable(s),z=this.buildJoins(o),R=i?v` where ${i}`:void 0,I=a?v` having ${a}`:void 0,j;u&&u.length>0&&(j=v` order by ${v.join(u,v`, `)}`);let G;c&&c.length>0&&(G=v` group by ${v.join(c,v`, `)}`);let Te=typeof l=="object"||typeof l=="number"&&l>=0?v` limit ${l}`:void 0,et=p?v` offset ${p}`:void 0,De=v.empty();if(d){let ue=v` for ${v.raw(d.strength)}`;d.config.of&&ue.append(v` of ${v.join(Array.isArray(d.config.of)?d.config.of:[d.config.of],v`, `)}`),d.config.noWait?ue.append(v` no wait`):d.config.skipLocked&&ue.append(v` skip locked`),De.append(ue)}let ve=v`${w}select${E} ${S} from ${N}${z}${R}${G}${I}${j}${Te}${et}${De}`;return y.length>0?this.buildSetOperations(ve,y):ve}buildSetOperations(e,r){let[n,...i]=r;if(!n)throw new Error("Cannot pass undefined values to any set operator");return i.length===0?this.buildSetOperationQuery({leftSelect:e,setOperator:n}):this.buildSetOperations(this.buildSetOperationQuery({leftSelect:e,setOperator:n}),i)}buildSetOperationQuery({leftSelect:e,setOperator:{type:r,isAll:n,rightSelect:i,limit:a,orderBy:s,offset:o}}){let u=v`(${e.getSQL()}) `,c=v`(${i.getSQL()})`,l;if(s&&s.length>0){let y=[];for(let g of s)if(b(g,k))y.push(v.identifier(g.name));else if(b(g,A)){for(let x=0;x<g.queryChunks.length;x++){let w=g.queryChunks[x];b(w,k)&&(g.queryChunks[x]=v.identifier(w.name))}y.push(v`${g}`)}else y.push(v`${g}`);l=v` order by ${v.join(y,v`, `)} `}let p=typeof a=="object"||typeof a=="number"&&a>=0?v` limit ${a}`:void 0,d=v.raw(`${r} ${n?"all ":""}`),f=o?v` offset ${o}`:void 0;return v`${u}${d}${c}${l}${p}${f}`}buildInsertQuery({table:e,values:r,onConflict:n,returning:i,withList:a,select:s,overridingSystemValue_:o}){let u=[],c=e[C.Symbol.Columns],l=Object.entries(c).filter(([w,E])=>!E.shouldDisableInsert()),p=l.map(([,w])=>v.identifier(this.casing.getColumnCasing(w)));if(s){let w=r;b(w,A)?u.push(w):u.push(w.getSQL())}else{let w=r;u.push(v.raw("values "));for(let[E,S]of w.entries()){let N=[];for(let[z,R]of l){let I=S[z];if(I===void 0||b(I,st)&&I.value===void 0)if(R.defaultFn!==void 0){let j=R.defaultFn(),G=b(j,A)?j:v.param(j,R);N.push(G)}else if(!R.default&&R.onUpdateFn!==void 0){let j=R.onUpdateFn(),G=b(j,A)?j:v.param(j,R);N.push(G)}else N.push(v`default`);else N.push(I)}u.push(N),E<w.length-1&&u.push(v`, `)}}let d=this.buildWithCTE(a),f=v.join(u),y=i?v` returning ${this.buildSelection(i,{isSingleTable:!0})}`:void 0,g=n?v` on conflict ${n}`:void 0,x=o===!0?v`overriding system value `:void 0;return v`${d}insert into ${e} ${p} ${x}${f}${g}${y}`}buildRefreshMaterializedViewQuery({view:e,concurrently:r,withNoData:n}){let i=r?v` concurrently`:void 0,a=n?v` with no data`:void 0;return v`refresh materialized view${i} ${e}${a}`}prepareTyping(e){return b(e,ja)||b(e,qa)?"json":b(e,Ra)?"decimal":b(e,Da)?"time":b(e,Ma)||b(e,La)?"timestamp":b(e,Ia)||b(e,Oa)?"date":b(e,Ba)?"uuid":"none"}sqlToQuery(e,r){return e.toQuery({casing:this.casing,escapeName:this.escapeName,escapeParam:this.escapeParam,escapeString:this.escapeString,prepareTyping:this.prepareTyping,invokeSource:r})}buildRelationalQueryWithoutPK({fullSchema:e,schema:r,tableNamesMap:n,table:i,tableConfig:a,queryConfig:s,tableAlias:o,nestedQueryRelation:u,joinOn:c}){let l=[],p,d,f=[],y,g=[];if(s===!0)l=Object.entries(a.columns).map(([E,S])=>({dbKey:S.name,tsKey:E,field:Ut(S,o),relationTableTsKey:void 0,isJson:!1,selection:[]}));else{let w=Object.fromEntries(Object.entries(a.columns).map(([I,j])=>[I,Ut(j,o)]));if(s.where){let I=typeof s.where=="function"?s.where(w,U1()):s.where;y=I&&Aa(I,o)}let E=[],S=[];if(s.columns){let I=!1;for(let[j,G]of Object.entries(s.columns))G!==void 0&&j in a.columns&&(!I&&G===!0&&(I=!0),S.push(j));S.length>0&&(S=I?S.filter(j=>s.columns?.[j]===!0):Object.keys(a.columns).filter(j=>!S.includes(j)))}else S=Object.keys(a.columns);for(let I of S){let j=a.columns[I];E.push({tsKey:I,value:j})}let N=[];s.with&&(N=Object.entries(s.with).filter(I=>!!I[1]).map(([I,j])=>({tsKey:I,queryConfig:j,relation:a.relations[I]})));let z;if(s.extras){z=typeof s.extras=="function"?s.extras(w,{sql:v}):s.extras;for(let[I,j]of Object.entries(z))E.push({tsKey:I,value:cp(j,o)})}for(let{tsKey:I,value:j}of E)l.push({dbKey:b(j,A.Aliased)?j.fieldAlias:a.columns[I].name,tsKey:I,field:b(j,W)?Ut(j,o):j,relationTableTsKey:void 0,isJson:!1,selection:[]});let R=typeof s.orderBy=="function"?s.orderBy(w,Q1()):s.orderBy??[];Array.isArray(R)||(R=[R]),f=R.map(I=>b(I,W)?Ut(I,o):Aa(I,o)),p=s.limit,d=s.offset;for(let{tsKey:I,queryConfig:j,relation:G}of N){let Te=V1(r,n,G),et=Hr(G.referencedTable),De=n[et],ve=`${o}_${I}`,ue=gr(...Te.fields.map((Ar,Ni)=>Re(Ut(Te.references[Ni],ve),Ut(Ar,o)))),ge=this.buildRelationalQueryWithoutPK({fullSchema:e,schema:r,tableNamesMap:n,table:e[De],tableConfig:r[De],queryConfig:b(G,yr)?j===!0?{limit:1}:{...j,limit:1}:j,tableAlias:ve,joinOn:ue,nestedQueryRelation:G}),dt=v`${v.identifier(ve)}.${v.identifier("data")}`.as(I);g.push({on:v`true`,table:new _e(ge.sql,{},ve),alias:ve,joinType:"left",lateral:!0}),l.push({dbKey:I,tsKey:I,field:dt,relationTableTsKey:De,isJson:!0,selection:ge.selection})}}if(l.length===0)throw new za({message:`No fields selected for table "${a.tsName}" ("${o}")`});let x;if(y=gr(c,y),u){let w=v`json_build_array(${v.join(l.map(({field:N,tsKey:z,isJson:R})=>R?v`${v.identifier(`${o}_${z}`)}.${v.identifier("data")}`:b(N,A.Aliased)?N.sql:N),v`, `)})`;b(u,$a)&&(w=v`coalesce(json_agg(${w}${f.length>0?v` order by ${v.join(f,v`, `)}`:void 0}), '[]'::json)`);let E=[{dbKey:"data",tsKey:"data",field:w.as("data"),isJson:!0,relationTableTsKey:a.tsName,selection:l}];p!==void 0||d!==void 0||f.length>0?(x=this.buildSelectQuery({table:Ca(i,o),fields:{},fieldsFlat:[{path:[],field:v.raw("*")}],where:y,limit:p,offset:d,orderBy:f,setOperators:[]}),y=void 0,p=void 0,d=void 0,f=[]):x=Ca(i,o),x=this.buildSelectQuery({table:b(x,Oe)?x:new _e(x,{},o),fields:{},fieldsFlat:E.map(({field:N})=>({path:[],field:b(N,W)?Ut(N,o):N})),joins:g,where:y,limit:p,offset:d,orderBy:f,setOperators:[]})}else x=this.buildSelectQuery({table:Ca(i,o),fields:{},fieldsFlat:l.map(({field:w})=>({path:[],field:b(w,W)?Ut(w,o):w})),joins:g,where:y,limit:p,offset:d,orderBy:f,setOperators:[]});return{tableTsKey:a.tsName,sql:x,selection:l}}};var Ho=class{static[m]="TypedQueryBuilder";getSelectedFields(){return this._.selectedFields}};var Fe=class{static[m]="PgSelectBuilder";fields;session;dialect;withList=[];distinct;constructor(e){this.fields=e.fields,this.session=e.session,this.dialect=e.dialect,e.withList&&(this.withList=e.withList),this.distinct=e.distinct}authToken;setToken(e){return this.authToken=e,this}from(e){let r=!!this.fields,n=e,i;return this.fields?i=this.fields:b(n,_e)?i=Object.fromEntries(Object.keys(n._.selectedFields).map(a=>[a,n[a]])):b(n,ri)?i=n[se].selectedFields:b(n,A)?i={}:i=Oo(n),new Vo({table:n,fields:i,isPartialSelect:r,session:this.session,dialect:this.dialect,withList:this.withList,distinct:this.distinct}).setToken(this.authToken)}},Cd=class extends Ho{static[m]="PgSelectQueryBuilder";_;config;joinsNotNullableMap;tableName;isPartialSelect;session;dialect;constructor({table:e,fields:r,isPartialSelect:n,session:i,dialect:a,withList:s,distinct:o}){super(),this.config={withList:s,table:e,fields:{...r},distinct:o,setOperators:[]},this.isPartialSelect=n,this.session=i,this.dialect=a,this._={selectedFields:r},this.tableName=Yt(e),this.joinsNotNullableMap=typeof this.tableName=="string"?{[this.tableName]:!0}:{}}createJoin(e){return(r,n)=>{let i=this.tableName,a=Yt(r);if(typeof a=="string"&&this.config.joins?.some(s=>s.alias===a))throw new Error(`Alias "${a}" is already used in this query`);if(!thi